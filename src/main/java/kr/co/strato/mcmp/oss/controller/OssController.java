package kr.co.strato.mcmp.oss.controller;

import java.util.List;

import kr.co.strato.mcmp.infra.model.InfraNameSpace;
import kr.co.strato.mcmp.infra.service.InfraProvisioningService;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.DeleteMapping;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.PutMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;
import kr.co.strato.mcmp.api.response.ResponseCode;
import kr.co.strato.mcmp.api.response.ResponseWrapper;
import kr.co.strato.mcmp.gitlab.service.GitLabService;
import kr.co.strato.mcmp.jenkins.service.JenkinsService;
import kr.co.strato.mcmp.nexus.service.NexusService;
import kr.co.strato.mcmp.oss.model.Oss;
import kr.co.strato.mcmp.oss.service.OssService;
import lombok.extern.slf4j.Slf4j;

@Slf4j
@Tag(name = "oss", description = "oss 설정 (GitLab, Jenkins, Harbor, Tumblebug 등)")
@RestController
public class OssController {

	@Autowired
	private OssService ossService;

	@Autowired
	private GitLabService gitlabService;

	@Autowired
	private JenkinsService jenkinsService;

	@Autowired
	private NexusService nexusService;

	@Autowired
	private InfraProvisioningService tumblebugService;

	@Operation(summary = "목록 조회", description = "" )
	@GetMapping("/config/oss/list")
	public ResponseWrapper<List<Oss>> getOssList(@RequestParam(value="ossCd", required=false) String ossCd) {
		return new ResponseWrapper<>(ossService.getOssList(ossCd));
	}
//
//	@Operation(summary = "상세", description = "" )
//	@GetMapping("/config/oss/{ossId}")
//	public ResponseWrapper<Oss> getOss(@PathVariable int ossId) {
//		return new ResponseWrapper<>(ossService.getOss(ossId));
//	}

	@Operation(summary = "OSS 정보 중복 체크(oss명, url, username)", description = "true : 중복 / false : 중복 아님")
	@GetMapping("/config/oss/duplicate")
	public ResponseWrapper<Boolean> isOssInfoDuplicated(@RequestParam String ossName, @RequestParam String ossUrl, @RequestParam String ossUsername) {
		if ( StringUtils.isBlank(ossName) ) {
    		return new ResponseWrapper<>(ResponseCode.BAD_REQUEST, "ossName");
		}
		else if ( StringUtils.isBlank(ossUrl) ) {
    		return new ResponseWrapper<>(ResponseCode.BAD_REQUEST, "ossUrl");
		}
		else if ( StringUtils.isBlank(ossUsername) ) {
    		return new ResponseWrapper<>(ResponseCode.BAD_REQUEST, "ossUsername");
		}

		Oss oss = new Oss();
		oss.setOssName(ossName);
		oss.setOssUrl(ossUrl);
		oss.setOssUsername(ossUsername);

		return new ResponseWrapper<>(ossService.isOssInfoDuplicated(oss));
	}

	@Operation(summary = "등록", description = "" )
	@PostMapping("/config/oss")
	public ResponseWrapper<Integer> createOss(@RequestBody Oss oss) {
		oss.setRegId("admin");
		oss.setRegName("admin");

		return new ResponseWrapper<>(ossService.createOss(oss));
	}

	@Operation(summary = "수정", description = "" )
	@PutMapping("/config/oss/{ossId}")
	public ResponseWrapper<Integer> updateOss(@PathVariable int ossId, @RequestBody Oss oss) {
		if ( oss.getOssId() == null || oss.getOssId() == 0 ) {
			oss.setOssId(ossId);
		}

		oss.setModId("admin");
		oss.setModName("admin");

		return new ResponseWrapper<>(ossService.updateOss(oss));
	}


	@Operation(summary = "삭제", description = "" )
	@DeleteMapping("/config/oss/{ossId}")
	public ResponseWrapper<Void> deleteOss(@PathVariable int ossId) {
		ossService.deleteOss(ossId);
		return new ResponseWrapper<>();
	}

	@Operation(summary = "연결확인", description = "" )
	@PostMapping("/config/oss/connection/check")
	public ResponseWrapper<Boolean> checkConnection(@RequestBody Oss oss) {
		switch(oss.getOssCd()) {
		case "JENKINS" :
			if ( StringUtils.isBlank(oss.getOssUrl())
					|| StringUtils.isBlank(oss.getOssUsername())
					|| StringUtils.isBlank(oss.getOssPassword()) ) {
	       		return new ResponseWrapper<>(ResponseCode.BAD_REQUEST, "접속 정보 누락");
			}

			// Front에서 Base64Encoding한 데이터를 복호화하여 AES256 암호화 함.
			oss.setOssPassword(ossService.encryptAesString(oss.getOssPassword()));

			return new ResponseWrapper<>(jenkinsService.isJenkinsConnect(oss));
		case "GITLAB" :
			if ( StringUtils.isBlank(oss.getOssUrl())
					|| StringUtils.isBlank(oss.getOssUsername())
					|| StringUtils.isBlank(oss.getOssPassword()) ) {
	       		return new ResponseWrapper<>(ResponseCode.BAD_REQUEST, "접속 정보 누락");
			}

			// Front에서 Base64Encoding한 데이터를 복호화하여 AES256 암호화 함.
			oss.setOssPassword(ossService.encryptAesString(oss.getOssPassword()));

			return new ResponseWrapper<>(gitlabService.isConnectByPw(oss));
		case "NEXUS" :
			if ( StringUtils.isBlank(oss.getOssUrl())
				|| StringUtils.isBlank(oss.getOssUsername()) ) {
	       		return new ResponseWrapper<>(ResponseCode.BAD_REQUEST, "접속 정보 누락");
			}

			// Front에서 Base64Encoding한 데이터를 복호화하여 AES256 암호화 함.
			oss.setOssToken(ossService.encryptAesString(oss.getOssToken()));

			return new ResponseWrapper<>(nexusService.checkNexusConnection(oss));
		case "TUMBLEBUG" :
			if ( StringUtils.isBlank(oss.getOssUrl())
					|| StringUtils.isBlank(oss.getOssUsername())
					|| StringUtils.isBlank(oss.getOssPassword()) ) {
				return new ResponseWrapper<>(ResponseCode.BAD_REQUEST, "접속 정보 누락");
			}

			try {
				oss.setOssPassword(ossService.encryptAesString(oss.getOssPassword()));

				List<InfraNameSpace> list = tumblebugService.getNamespaceList(oss.getOssUsername(), oss.getOssPassword(), oss.getOssUrl());

				if(list.size() >= 0)
					return new ResponseWrapper<>(true);
				else
					return new ResponseWrapper<>(false);
			} catch (Exception e) {
				log.error("API CALL Fail");
			}

		default:
			log.debug("[checkConnection] oss code >>> {}", oss.getOssCd());
			return new ResponseWrapper<>(ResponseCode.BAD_REQUEST, "등록되지 않는 Code입니다.");
		}
	}
}